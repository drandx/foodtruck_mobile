// This file has been autogenerated from a class added in the UI designer.

using System;

using MonoTouch.Foundation;
using MonoTouch.UIKit;
using DInteractive.Core;
using System.Threading;

namespace DInteractive.iOS
{
	public partial class ServiceRequestController : MyViewController
	{

		readonly CategoriesModel categoriesModel = (CategoriesModel)DependencyInjectionWrapper.Instance.ServiceContainer ().GetService (typeof(CategoriesModel));
		readonly OrdersModel ordersModel = (OrdersModel)DependencyInjectionWrapper.Instance.ServiceContainer ().GetService (typeof(OrdersModel));

		public ServiceRequestController (IntPtr handle) : base (handle)
		{

		}

		public override async void ViewDidAppear(bool animated)
		{

			try 
			{
				await ordersModel.RequestService (categoriesModel.SelectedSubcategory, this.RequestServiceCallBack);
			}
			catch (Exception exc)
			{
				new UIAlertView("Oops!", "Error solicitando servicio", null, "Ok").Show();
			}

		}

		public override void ViewDidLoad ()
		{
			base.ViewDidLoad ();
			imgCat.Image = UIImage.FromBundle (categoriesModel.SelectedCategory.ImageName);
			this.AddKeyboarListeners ();
			this.NavigationItem.SetHidesBackButton (true, false);
			lblSubCategory.Text = categoriesModel.SelectedSubcategory.Name;
		}

		/**
		 * 
		 * 
		 * */
		/*async*/ 
		void CheckStatus(Object state) {
			OrderStateTimer s = (OrderStateTimer) state;
			try
			{
				//
				Order ret = ordersModel.GetOrder(ordersModel.RequestedOrderId);
				if((ret != null) && ((ret.Status == ServiceState.CONFIRMADO) || (s.AttemptsCount == Constants.GET_ORDER_STATUS_ATTEMPTS)))
				{
					Console.WriteLine("disposing of timer...");
					s.tmr.Dispose();
					s.tmr = null;
				}
				s.AttemptsCount++;
			}
			catch (Exception exc)
			{
				Console.WriteLine("Error obteniendo orden en CheckStatus()");
			}
		}

		/*
		 * 
		 * 
		 * 
		*/
		private async void RequestServiceCallBack()
		{
			try {
				//Timer Code Starts Here
				OrderStateTimer timerState = new OrderStateTimer();
				TimerCallback timerDelegate = new TimerCallback(CheckStatus);
				Timer timer = new Timer(timerDelegate, timerState, 10000, Constants.GET_ORDER_STATUS_WAIT_TIME);
				timerState.tmr = timer;
				while (timerState.tmr != null)
					Thread.Sleep(0);
				Console.WriteLine("Timer done.");
				//Ends Timer Code

				if(ordersModel.RequestedOrder.Status != ServiceState.CONFIRMADO)
				{
					await ordersModel.ChangeRequestedOrderStateAsync(ServiceState.TIME_OUT_PROVEEDOR);
					new UIAlertView("Oops!", "En el momento no hay proveedores disponibles, porfavor vuelve a intentarlo mas tarde", null, "Ok").Show();
					NavigationController. PopViewControllerAnimated(true);
				}
				else
				{
					PerformSegue("OnConfirmed",this);
				}
			}
			catch (Exception exc)
			{
				Console.WriteLine("Error cambiando orden de estado en RequestServiceCallBack"+exc.Message);
			}

		}

		public override void ViewWillAppear(bool animated)
		{
			base.ViewWillAppear(false);
			ordersModel.IsBusyChanged += OnIsBusyChanged;
		}

		public override void ViewWillDisappear(bool animated)
		{
			base.ViewWillDisappear(false);
			ordersModel.IsBusyChanged -= OnIsBusyChanged;
		}

		void OnIsBusyChanged(object sender, EventArgs e)
		{
			//txtEmail.Enabled = 
				//txtPassword.Enabled =
					//btnLogIn.Enabled =
			indicator.Hidden = !ordersModel.IsBusy;
		}

	}
}
